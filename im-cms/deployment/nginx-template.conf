# OpenIM CMS 反向代理配置文件模板
# 使用方法：替换 {{SERVER_IP}} 为实际的服务器IP地址

# 管理后台服务 (端口 8080 - chat服务)
upstream admin_backend {
    server chat-service.default.svc.cluster.local:8080;
}

# 用户服务 (端口 8080 - chat服务)
upstream user_backend {
    server chat-service.default.svc.cluster.local:8080;
}

# IM 系统服务 (端口 10001 - open-im-server)
upstream im_backend {
    server open-im-server-service.default.svc.cluster.local:10001;
}

server {
    listen 80;
    server_name localhost;
    
    # 客户端最大请求体大小
    client_max_body_size 100M;
    
    # 代理超时设置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # 通用代理头设置
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # ==================== 管理后台服务 (端口 10009) ====================
    # 管理后台相关接口 - /api/admin/*
    location /api/admin {
        proxy_pass http://admin_backend;
        rewrite ^/api/admin(.*)$ $1 break;
    }
    
    # ==================== 用户服务 (端口 10008) ====================
    # 用户服务相关接口 - /api/user/*
    location /api/user {
        proxy_pass http://user_backend;
        rewrite ^/api/user(.*)$ $1 break;
    }
    
    # ==================== IM 系统服务 (端口 10002) ====================
    # IM 系统相关接口 - /api/im/*
    location /api/im {
        proxy_pass http://im_backend;
        rewrite ^/api/im(.*)$ $1 break;
    }
    
    # ==================== 静态文件服务 ====================
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
    }
    
    # 错误页面
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
